<!DOCTYPE html>
<html><head>
<title>2021牛客多校3</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="/scss/journal.min.8e28ea12f6e17fa31de20b68201547b6843cb5deca28115ad2f58c2a899823e3.css" integrity="sha256-jijqEvbhf6Md4gtoIBVHtoQ8td7KKBFa0vWMKomYI&#43;M=" media="screen">



<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>















<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"]], [["\\(", "\\)"]],
    },
    displayMath: [
      ["$$", "$$"],
      ["\\[", "\\]"],
    ],
    svg: {
      fontCache: "global",
    },
    options: {
    enableMenu: true,          
    menuOptions: {
      settings: {
        texHints: true,        
        semantics: false,      
        zoom: 'NoZoom',        
        zscale: '200%',        
        renderer: 'CHTML',     
        alt: false,            
        cmd: false,            
        ctrl: false,           
        shift: false,          
        scale: 1,              
        inTabOrder: true,      

        assistiveMml: true,    
        collapsible: false,    
        explorer: false,       
      },
      annotationTypes: {
        TeX: ['TeX', 'LaTeX', 'application/x-tex'],
        StarMath: ['StarMath 5.0'],
        Maple: ['Maple'],
        ContentMathML: ['MathML-Content', 'application/mathml-content+xml'],
        OpenMath: ['OpenMath']
      }
    }
  }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js">
    MathJax.Hub.Queue(function () {
      
      
      
      var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

<style>
  code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
  }
</style>

<link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.1/styles/atom-one-dark.min.css" rel="stylesheet">
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.initLineNumbersOnLoad();</script>

</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://blog.asukakyle.top">
    
        <div class="nav-title">
            HolyK&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            明日は明日の風が吹く
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/post">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friend">
                Friends
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	CC BY-NC-SA 4.0
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/post">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friend">
                    Friends
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://blog.asukakyle.top">
            HolyK&#39;s Blog
        </a>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://blog.asukakyle.top">
        <div class="single-column-header-title">HolyK&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">明日は明日の風が吹く</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper"
                
                    style="background-image: url('http://www.dmoe.cc/random.php')"
                
            >
                <div class="post-title">
                    2021牛客多校3
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2021-07-31 11:28
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/%E9%A2%98%E8%A7%A3">题解</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/%E5%A4%9A%E6%A0%A1">多校</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    | 题号 |                             标题                             | 团队的状态 |
| :--: | :----------------------------------------------------------: | :--------: |
|  A   | [Guess and lies](https://ac.nowcoder.com/acm/contest/11254/A) |    通过    |
|  B   | [Black and white](https://ac.nowcoder.com/acm/contest/11254/B) |    通过    |
|  C   | [Minimum grid](https://ac.nowcoder.com/acm/contest/11254/C)  |    通过    |
|  D   |     [Count](https://ac.nowcoder.com/acm/contest/11254/D)     |    通过    |
|  E   |     [Math](https://ac.nowcoder.com/acm/contest/11254/E)      |    通过    |
|  F   |    [24dian](https://ac.nowcoder.com/acm/contest/11254/F)     |    通过    |
|  G   | [Yu Ling(Ling YueZheng) and Colorful Tree](https://ac.nowcoder.com/acm/contest/11254/G) |    通过    |
|  H   | [Ling Qiu, Luna and Triple Backpack](https://ac.nowcoder.com/acm/contest/11254/H) |   未通过   |
|  I   | [Kuriyama Mirai and Exclusive Or](https://ac.nowcoder.com/acm/contest/11254/I) |    通过    |
|  J   | [Counting Triangles](https://ac.nowcoder.com/acm/contest/11254/J) |    通过    |


## [Guess and lies](https://ac.nowcoder.com/acm/contest/11254/A) 

## [Black and white](https://ac.nowcoder.com/acm/contest/11254/B) 

## [Minimum grid](https://ac.nowcoder.com/acm/contest/11254/C)  

## [Count](https://ac.nowcoder.com/acm/contest/11254/D)     

## [Math](https://ac.nowcoder.com/acm/contest/11254/E)      

## [24dian](https://ac.nowcoder.com/acm/contest/11254/F)     

## [Yu Ling(Ling YueZheng) and Colorful Tree](https://ac.nowcoder.com/acm/contest/11254/G) 
> 一棵 $n$ 个点的树，1 是根。$q$ 次操作：
>
> - `0 u x` 令 $\mathrm{color}_u=x$。
> - `1 u l r x` 询问离 $u$ 的最近祖先 $v$ 满足 $l \leq \mathrm{color}_v \leq r, x \mid \mathrm{color}_v$。
>
> $n, q \leq 1.1\times 10^5, 1 \leq x \leq n$，**染色操作的点和颜色都互不相同**。

跑一遍 dfs 序，祖先的限制转化为 $\mathrm{in}_v \leq \mathrm{in}_u \leq \mathrm{out}_v$。

离线，将染色 $x$ 和询问颜色 $x$ 的操作都存下来，分别处理。

对于颜色 $x$ 的询问，将 $l, r$ 离散化，然后枚举 $x$ 的倍数去掉 $x \mid \mathrm{color}_v$ 的限制。

剩下来是一个三维偏序问题：
$$
\begin{cases}
t_v < t_u, \\
\mathrm{in}_v \leq \mathrm{in}_u \leq \mathrm{out}_v,\\
l \leq \mathrm{color}_v \leq r
\end{cases}
$$
可以树套树解决。

对于离散化后的颜色区间建立线段树，将询问和修改都挂在线段树上，去掉第三维。

然后对线段树的每个节点做一个二维偏序即可。

复杂度 $O(n \log^3 n)$。

```cpp
// Author:  HolyK
// Created: Sun Jul 25 14:59:29 2021
#include <bits/stdc++.h>
#define dbg(a...) fprintf(stderr, a)
template <class T, class U>
inline bool smin(T &x, const U &y) {
  return y < x ? x = y, 1 : 0;
}
template <class T, class U>
inline bool smax(T &x, const U &y) {
  return x < y ? x = y, 1 : 0;
}

using LL = long long;
using PII = std::pair<int, int>;
inline char gc() {
  static constexpr int BufferSize = 1 << 22 | 5;
  static char buf[BufferSize], *p, *q;
  static std::streambuf *i = std::cin.rdbuf();
  return p == q ? p = buf, q = p + i->sgetn(p, BufferSize), p == q ? EOF : *p++ : *p++;
}
struct Reader {
  template <class T>
  Reader &operator>>(T &w) {
    char c, p = 0;
    for (; !std::isdigit(c = gc());) if (c == '-') p = 1;
    for (w = c & 15; std::isdigit(c = gc()); w = w * 10 + (c & 15)) ;
    if (p) w = -w;
    return *this;
  }
} cin;

constexpr int N(1.1e5 + 5);
int n, m;
std::vector<PII> g[N];
LL d[N];
int in[N], out[N], cnt;
void dfs(int x, int p) {
  in[x] = cnt++;
  for (auto [y, z] : g[x]) {
    if (y == p) continue;
    d[y] = d[x] + z;
    dfs(y, x);
  }
  out[x] = cnt;
}
int main() {
  std::ios::sync_with_stdio(false);
  std::cin.tie(nullptr);
  cin >> n >> m;
  for (int i = 1, x, y, z; i < n; i++) {
    cin >> x >> y >> z;
    x--, y--;
    g[x].emplace_back(y, z);
    g[y].emplace_back(x, z);
  }
  d[0] = 1;
  dfs(0, -1);
  std::vector<PII> a(n + 1, PII(-1, -1));
  using Qry = std::array<int, 4>;
  std::vector<std::vector<Qry>> q(n + 1);
  std::vector<LL> ans(m);
  for (int i = 0; i < m; i++) {
    int opt, u, l, r, x;
    cin >> opt >> u;
    u--;
    if (opt == 0) {
      cin >> x;
      assert(a[x].first == -1);
      a[x] = {u, i};
      ans[i] = -1;
    } else {
      cin >> l >> r >> x;
      l = (l + x - 1) / x * x;
      r = (r + x) / x * x;
      ans[i] = 1e18;
      if (l < r) {
        q[x].push_back({u, l, r, i});
      }
    }
  }
  std::vector<int> p;
  std::vector<Qry> b;
  for (int x = 1; x <= n; x++) {
    if (q[x].empty()) continue;
    p.clear();
    for (auto [u, l, r, id] : q[x]) {
      p.push_back(l);
      p.push_back(r);
    }
    std::sort(p.begin(), p.end());
    p.resize(std::unique(p.begin(), p.end()) - p.begin());
    b.clear();
#define low(x) int(std::lower_bound(p.begin(), p.end(), x) - p.begin())
#define upp(x) int(std::upper_bound(p.begin(), p.end(), x) - p.begin())
    for (int y = p[0]; y < p.back(); y += x) {
      if (a[y].first == -1) continue;
      auto [u, id] = a[y];
      b.push_back({id, u, upp(y) - 1, -1});
    }
    for (auto [u, l, r, id] : q[x]) {
      b.push_back({id, u, low(l), low(r)});
    }
    std::sort(b.begin(), b.end());
    int s = 1 << std::__lg(p.size() * 2 - 1);
    std::vector<int> len(2 * s);
    for (auto [id, u, l, r] : b) {
      if (r == -1) {
        for (l += s; l; l >>= 1) {
          len[l]++;
        }
      } else {
        for (l += s, r += s; l < r; l >>= 1, r >>= 1) {
          if (l & 1) {
            len[l++]++;
          }
          if (r & 1) {
            len[--r]++;
          }
        }
      }
    }
    std::vector<std::vector<PII>> t(2 * s);
    for (int i = 1; i < 2 * s; i++) t.reserve(len[i]);
    
    for (auto [id, u, l, r] : b) {
      if (r == -1) {
        for (l += s; l; l >>= 1) {
          t[l].emplace_back(id, u);
        }
      } else {
        for (l += s, r += s; l < r; l >>= 1, r >>= 1) {
          if (l & 1) {
            t[l++].emplace_back(id, u);
          }
          if (r & 1) {
            t[--r].emplace_back(id, u);
          }
        }
      }
    }
    for (auto &v : t) {
      if (v.empty()) continue;
      p.clear();
      for (auto [id, u] : v) {
        if (~ans[id]) p.push_back(in[u]);
      }
      std::sort(p.begin(), p.end());
      p.resize(std::unique(p.begin(), p.end()) - p.begin());
      int s = 1 << std::__lg(p.size() * 2 - 1);
      std::vector<LL> max(2 * s);
      for (auto [id, u] : v) {
        if (ans[id] == -1) {
          for (int l = s + low(in[u]), r = s + low(out[u]); l < r; l >>= 1, r >>= 1) {
            if (l & 1) smax(max[l++], d[u]);
            if (r & 1) smax(max[--r], d[u]);
          }
        } else {
          LL m = 0;
          for (int l = s + low(in[u]); l; l >>= 1) {
            smax(m, max[l]);
          }
          if (m) smin(ans[id], d[u] - m);
        }
      }
    }
  }
  for (int i = 0; i < m; i++) {
    if (~ans[i]) {
      if (ans[i] < 1e18) {
        std::cout << ans[i] << "\n";
      } else {
        std::cout << "Impossible!\n";
      }
    }
  }
  return 0;
}
```

## [Ling Qiu, Luna and Triple Backpack](https://ac.nowcoder.com/acm/contest/11254/H)

## [Kuriyama Mirai and Exclusive Or](https://ac.nowcoder.com/acm/contest/11254/I) 

## [Counting Triangles](https://ac.nowcoder.com/acm/contest/11254/J) 


                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">最后修改于 2021-08-13</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/post/2021nowcoder6/">
			下回<br>2021牛客多校6
                </a>
                
                
                
                <a class="older-posts" href="/post/noi2021-%E5%AF%86%E7%A0%81%E7%AE%B1/">
			上回<br>[NOI2021] 密码箱
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                










            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	CC BY-NC-SA 4.0
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
